<section *ngIf="offer() as o">
    <!-- Breadcrumb & Back -->
    <div class="nav-header">
        <button class="btn-back" routerLink="/offres" title="Retour aux offres">
            <i class="fa-solid fa-circle-left"></i> Retour
        </button>
        <div class="breadcrumb">
            <span class="crumb-link" routerLink="/offres" title="Retour aux offres">Mes Offres</span>
            <span class="separator">></span>
            <span class="current">{{ o.title }}</span>
        </div>
    </div>

    <!-- Header Section -->
    <div class="offer-header-card glass">
        <div class="header-main">
            <div class="company-logo">{{ o.company.charAt(0) }}</div>
            <div class="header-info">
                <h1>{{ o.title }}</h1>
                <div class="subtitle">
                    <span class="company">{{ o.company }}</span>
                    <span class="separator">‚Ä¢</span>
                    <span class="location">üìç {{ o.location }}</span>
                </div>
            </div>
        </div>
        <div class="header-actions">
            <span class="status-badge" [style.background-color]="statusColors[o.status].background"
                [style.color]="statusColors[o.status].color" [style.border]="statusColors[o.status].border">
                {{ getStatusLabel(o.status) }}
            </span>
            <div class="action-buttons">
                <button class="btn btn-outline" (click)="openEditModal()" title="Modifier l'offre">
                    <i class="fa-solid fa-pen"></i> Modifier
                </button>
                <button class="btn btn-danger" (click)="confirmDelete()" title="Supprimer l'offre">
                    <i class="fa-solid fa-trash"></i> Supprimer
                </button>
            </div>
        </div>
    </div>

    <!-- Content Grid -->
    <div class="content-grid">
        <!-- Main Info -->
        <div class="main-column">
            <div class="card section" *ngIf="o.description || o.missions || o.profile">
                <h3>Description du poste</h3>
                <div class="info-block" *ngIf="o.missions">
                    <h4>Missions</h4>
                    <p>{{ o.missions }}</p>
                </div>
                <div class="info-block" *ngIf="o.profile">
                    <h4>Profil recherch√©</h4>
                    <p>{{ o.profile }}</p>
                </div>
                <div class="info-block" *ngIf="o.description && !o.missions">
                    <h4>Description</h4>
                    <p>{{ o.description }}</p>
                </div>
            </div>

            <div class="card section">
                <div class="description">
                    <h3>√Ä propos de l'entreprise</h3>
                    <button class="btn btn-outline" (click)="viewCompany(o)" title="Voir la page de l'entreprise">Voir
                        l'entreprise</button>
                </div>
                <p *ngIf="o.companyDescription">{{ o.companyDescription }}</p>

                <div class="company-metrics" *ngIf="o.companyInfo">
                    <div class="metric" *ngIf="o.companyInfo.employees">
                        <i class="fa-solid fa-users"></i>
                        <div>
                            <span class="label">Employ√©s</span>
                            <span class="value">{{ o.companyInfo.employees }}</span>
                        </div>
                    </div>
                    <div class="metric" *ngIf="o.companyInfo.founded">
                        <i class="fa-solid fa-flag"></i>
                        <div>
                            <span class="label">Cr√©ation</span>
                            <span class="value">{{ o.companyInfo.founded }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar Info -->
        <div class="sidebar-column">
            <div class="card section">
                <h3>D√©tails cl√©s</h3>
                <ul class="key-details">
                    <li *ngIf="o.contractType">
                        <span class="icon">üìÑ</span>
                        <div>
                            <span class="label">Contrat</span>
                            <span class="value">{{ o.contractType }}</span>
                        </div>
                    </li>
                    <li *ngIf="o.contractDuration">
                        <span class="icon">‚è±Ô∏è</span>
                        <div>
                            <span class="label">Dur√©e</span>
                            <span class="value">{{ o.contractDuration }}</span>
                        </div>
                    </li>
                    <li *ngIf="o.weeklyHours">
                        <span class="icon">‚åö</span>
                        <div>
                            <span class="label">Hebdo</span>
                            <span class="value">{{ o.weeklyHours }}</span>
                        </div>
                    </li>
                    <li *ngIf="o.salary">
                        <span class="icon">üí∞</span>
                        <div>
                            <span class="label">Salaire</span>
                            <span class="value">{{ o.salary }}</span>
                        </div>
                    </li>
                    <li *ngIf="o.link">
                        <span class="icon">üîó</span>
                        <div>
                            <span class="label">Lien</span>
                            <a [href]="o.link" target="_blank" class="link" title="Consulter l'annonce">Voir
                                l'annonce</a>
                        </div>
                    </li>
                </ul>
            </div>

            <!-- Interviews Section (separate card) -->
            <div class="card section" *ngIf="o.status === 'Interview' || (o.interviews && o.interviews.length > 0)">
                <div class="section-header">
                    <h3>Entretiens</h3>
                    <button class="btn-icon-edit" (click)="openInterviewsModal()" title="Modifier les entretiens">
                        <i class="fa-solid fa-pen"></i>
                    </button>
                </div>
                <div class="interview-sections" *ngIf="o.interviews && o.interviews.length > 0">
                    <!-- Upcoming Interviews -->
                    <div class="interview-section" *ngIf="getUpcomingInterviews(o.interviews).length > 0">
                        <h5 class="interview-subtitle">√Ä venir</h5>
                        <div class="interview-items">
                            <div *ngFor="let interview of getUpcomingInterviews(o.interviews)" class="interview-item">
                                <span class="interview-type">{{ interview.type }}</span>
                                <span class="interview-date">le {{ interview.date | date:'dd/MM/yyyy' }}</span>
                                <span class="interview-details" *ngIf="interview.details">- {{ interview.details
                                    }}</span>
                            </div>
                        </div>
                    </div>
                    <!-- Past Interviews -->
                    <div class="interview-section" *ngIf="getPastInterviews(o.interviews).length > 0">
                        <h5 class="interview-subtitle">Pass√©s</h5>
                        <div class="interview-items">
                            <div *ngFor="let interview of getPastInterviews(o.interviews)" class="interview-item past">
                                <span class="interview-type">{{ interview.type }}</span>
                                <span class="interview-date">le {{ interview.date | date:'dd/MM/yyyy' }}</span>
                                <span class="interview-details" *ngIf="interview.details">- {{ interview.details
                                    }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Empty state when no interviews -->
                <div *ngIf="!o.interviews || o.interviews.length === 0" style="text-align: center; padding: 1rem;">
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">Aucun entretien programm√©</p>
                    <button class="btn btn-outline" (click)="openInterviewsModal()" title="Ajouter un entretien">
                        <i class="fa-solid fa-plus"></i> Ajouter un entretien
                    </button>
                </div>
            </div>

            <div class="card section" *ngIf="o.statusHistory && o.statusHistory.length > 0">
                <div class="section-header">
                    <h3>Historique du statut</h3>
                    <button class="btn-icon-edit" (click)="openStatusHistoryModal()" title="Modifier l'historique">
                        <i class="fa-solid fa-pen"></i>
                    </button>
                </div>
                <ul class="status-history">
                    <li *ngFor="let history of getSortedStatusHistory(o.statusHistory || [])">
                        <span class="history-status" [style.color]="statusColors[history.status].color">{{
                            getStatusLabel(history.status) }}</span>
                        <span class="history-date">{{ history.date | date:'dd/MM/yyyy' }}</span>
                    </li>
                </ul>
            </div>

            <div class="card section" *ngIf="o.benefits">
                <h3>Avantages</h3>
                <p>{{ o.benefits }}</p>
            </div>

            <div class="card section" *ngIf="o.recruitmentProcess">
                <h3>Processus de recrutement</h3>
                <p>{{ o.recruitmentProcess }}</p>
            </div>

            <div class="card section" *ngIf="o.others">
                <h3>Autres informations</h3>
                <p>{{ o.others }}</p>
            </div>
        </div>
    </div>
</section>

<!-- Edit Modal -->
<div class="modal-overlay" *ngIf="showEditModal()">
    <div class="modal-content stepper-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h3>Modifier l'offre</h3>
            <button class="close-btn" (click)="closeEditModal()" title="Fermer">√ó</button>
        </div>
        <div class="modal-body">
            <app-offer-form [offer]="offer() || null" (save)="onUpdateOffer($event)" (cancel)="closeEditModal()">
            </app-offer-form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-overlay" *ngIf="showDeleteConfirm()">
    <div class="modal-content confirm-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h3>Supprimer l'offre ?</h3>
            <button class="close-btn" (click)="cancelDelete()" title="Fermer">√ó</button>
        </div>
        <div class="modal-body-confirm">
            <p>√ätes-vous s√ªr de vouloir supprimer cette offre ? Cette action est irr√©versible.</p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" (click)="cancelDelete()" title="Annuler la suppression">Annuler</button>
            <button class="btn btn-danger" (click)="deleteOffer()" title="Confirmer la suppression">Supprimer</button>
        </div>
    </div>
</div>

<!-- Interviews Edit Modal -->
<div class="modal-overlay" *ngIf="showInterviewsModal()">
    <div class="modal-content edit-list-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h3>G√©rer les entretiens</h3>
            <button class="close-btn" (click)="closeInterviewsModal()" title="Fermer">√ó</button>
        </div>
        <div class="modal-body">
            <div class="edit-list-container">
                <!-- Existing Interviews -->
                <div class="existing-items" *ngIf="editingInterviews.length > 0">
                    <h4>Entretiens enregistr√©s</h4>
                    <div class="item-list">
                        <div *ngFor="let interview of editingInterviews; let i = index" class="edit-item">
                            <div class="item-content">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Type</label>
                                        <select [(ngModel)]="interview.type" class="form-control">
                                            <option *ngFor="let type of interviewTypes" [value]="type">{{ type }}
                                            </option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Date *</label>
                                        <mat-form-field>
                                            <input matInput [matDatepicker]="pickerInterview"
                                                [(ngModel)]="interview.date" />
                                            <mat-datepicker-toggle matIconSuffix
                                                [for]="pickerInterview"></mat-datepicker-toggle>
                                            <mat-datepicker #pickerInterview></mat-datepicker>
                                        </mat-form-field>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>D√©tails (optionnel)</label>
                                    <input type="text" [(ngModel)]="interview.details" class="form-control"
                                        placeholder="Ex: Avec le CTO">
                                </div>
                            </div>
                            <button class="btn-remove" (click)="confirmDeleteInterview(i)" title="Supprimer">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Add New Interview -->
                <div class="add-new-section">
                    <h4>Ajouter un entretien</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Type</label>
                            <select [(ngModel)]="newInterview.type" class="form-control">
                                <option *ngFor="let type of interviewTypes" [value]="type">{{ type }}</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Date *</label>
                            <mat-form-field>
                                <input matInput [matDatepicker]="pickerNewInterview" [(ngModel)]="newInterview.date" />
                                <mat-datepicker-toggle matIconSuffix [for]="pickerNewInterview"></mat-datepicker-toggle>
                                <mat-datepicker #pickerNewInterview></mat-datepicker>
                            </mat-form-field>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>D√©tails (optionnel)</label>
                        <input type="text" [(ngModel)]="newInterview.details" class="form-control"
                            placeholder="Ex: Avec le CTO">
                    </div>
                    <button class="btn btn-outline" (click)="addInterview()" title="Ajouter cet entretien">
                        <i class="fa-solid fa-plus"></i> Ajouter
                    </button>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" (click)="closeInterviewsModal()"
                title="Annuler les modifications">Annuler</button>
            <button class="btn btn-primary" (click)="saveInterviews()"
                title="Enregistrer les entretiens">Enregistrer</button>
        </div>
    </div>
</div>

<!-- Status History Edit Modal -->
<div class="modal-overlay" *ngIf="showStatusHistoryModal()">
    <div class="modal-content edit-list-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h3>G√©rer l'historique des statuts</h3>
            <button class="close-btn" (click)="closeStatusHistoryModal()" title="Fermer">√ó</button>
        </div>
        <div class="modal-body">
            <div class="edit-list-container">
                <!-- Existing Status History -->
                <div class="existing-items" *ngIf="editingStatusHistory.length > 0">
                    <h4>Historique enregistr√©</h4>
                    <div class="item-list">
                        <div *ngFor="let entry of editingStatusHistory; let i = index" class="edit-item">
                            <div class="item-content">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Statut</label>
                                        <select [(ngModel)]="entry.status" class="form-control">
                                            <option *ngFor="let status of possibleStatuses" [value]="status">
                                                {{ getStatusLabel(status) }}
                                            </option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Date *</label>
                                        <mat-form-field>
                                            <input matInput [matDatepicker]="pickerStatusHistory"
                                                [(ngModel)]="entry.date" [max]="maxDate" />
                                            <mat-datepicker-toggle matIconSuffix
                                                [for]="pickerStatusHistory"></mat-datepicker-toggle>
                                            <mat-datepicker #pickerStatusHistory></mat-datepicker>
                                        </mat-form-field>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>D√©tails (optionnel)</label>
                                    <input type="text" [(ngModel)]="entry.details" class="form-control"
                                        placeholder="Ex: Relance par email">
                                </div>
                            </div>
                            <button class="btn-remove" (click)="confirmDeleteStatus(i)" title="Supprimer">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Add New Status -->
                <div class="add-new-section">
                    <h4>Ajouter un statut</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Statut</label>
                            <select [(ngModel)]="newStatusEntry.status" class="form-control">
                                <option *ngFor="let status of possibleStatuses" [value]="status">
                                    {{ getStatusLabel(status) }}
                                </option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Date *</label>
                            <mat-form-field>
                                <input matInput [matDatepicker]="pickerNewStatus" [(ngModel)]="newStatusEntry.date"
                                    [max]="maxDate" />
                                <mat-datepicker-toggle matIconSuffix [for]="pickerNewStatus"></mat-datepicker-toggle>
                                <mat-datepicker #pickerNewStatus></mat-datepicker>
                            </mat-form-field>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>D√©tails (optionnel)</label>
                        <input type="text" [(ngModel)]="newStatusEntry.details" class="form-control"
                            placeholder="Ex: Relance par email">
                    </div>
                    <button class="btn btn-outline" (click)="addStatusHistory()" title="Ajouter ce statut">
                        <i class="fa-solid fa-plus"></i> Ajouter
                    </button>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" (click)="closeStatusHistoryModal()"
                title="Annuler les modifications">Annuler</button>
            <button class="btn btn-primary" (click)="saveStatusHistory()"
                title="Enregistrer l'historique">Enregistrer</button>
        </div>
    </div>
</div>

<!-- Delete Interview Confirmation Modal -->
<div class="modal-overlay" *ngIf="showDeleteInterviewConfirm()">
    <div class="modal-content confirm-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h3>Supprimer l'entretien ?</h3>
            <button class="close-btn" (click)="cancelDeleteInterview()" title="Fermer">√ó</button>
        </div>
        <div class="modal-body-confirm">
            <p>√ätes-vous s√ªr de vouloir supprimer cet entretien ? Cette action est irr√©versible.</p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" (click)="cancelDeleteInterview()"
                title="Annuler la suppression">Annuler</button>
            <button class="btn btn-danger" (click)="removeInterview()"
                title="Confirmer la suppression">Supprimer</button>
        </div>
    </div>
</div>

<!-- Delete Status History Confirmation Modal -->
<div class="modal-overlay" *ngIf="showDeleteStatusConfirm()">
    <div class="modal-content confirm-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h3>Supprimer le statut ?</h3>
            <button class="close-btn" (click)="cancelDeleteStatus()" title="Fermer">√ó</button>
        </div>
        <div class="modal-body-confirm">
            <p>√ätes-vous s√ªr de vouloir supprimer cette entr√©e de l'historique ? Cette action est irr√©versible.</p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" (click)="cancelDeleteStatus()"
                title="Annuler la suppression">Annuler</button>
            <button class="btn btn-danger" (click)="removeStatusHistory()"
                title="Confirmer la suppression">Supprimer</button>
        </div>
    </div>
</div>